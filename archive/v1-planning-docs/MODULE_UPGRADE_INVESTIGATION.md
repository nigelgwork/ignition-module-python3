# Module Upgrade Issue Investigation

**Date:** October 16, 2025
**Module:** Python 3 Integration
**Issue:** Module upgrades fail, requiring manual uninstall/reinstall

## Problem Summary

Module upgrades from v1.7.0 â†’ v1.7.1, v1.7.1 â†’ v1.7.2, and v1.7.2 â†’ v1.7.3 all failed. User must manually uninstall old version and install new version with Gateway restart.

## Investigation Completed

### 1. SDK Documentation Review

**Findings:**
- Module.xml is auto-generated by `io.ia.sdk.modl` Gradle plugin
- Module ID must remain consistent for upgrades
- Version field changes between releases
- Framework version and Ignition version requirements must be compatible

**Key Fields Affecting Upgrades:**
- `id`: Must stay same across versions âœ… (We use: `com.inductiveautomation.ignition.examples.python3`)
- `version`: Changes with each release âœ… (Currently: `1.7.3`)
- `requiredIgnitionVersion`: `8.3.0` âœ…
- `requiredFrameworkVersion`: `8` âœ…

### 2. JAR Naming Analysis

**v1.7.0 and v1.7.1 had VERSIONED jar names:**
```xml
<jar scope="G">common-1.7.0.jar</jar>
<jar scope="G">gateway-1.7.0.jar</jar>
<jar scope="D">designer-1.7.0.jar</jar>
```

**v1.7.2 and v1.7.3 have STATIC jar names:**
```xml
<jar scope="G">common.jar</jar>
<jar scope="G">gateway.jar</jar>
<jar scope="D">designer.jar</jar>
```

**Hypothesis:** Changing jar names prevented v1.7.0 â†’ v1.7.1 upgrade.
**HOWEVER:** v1.7.2 â†’ v1.7.3 should have worked (both have static names) but didn't!

### 3. Scope Changes

**v1.6.1 had:**
- Common: G
- Gateway: G
- Designer: DISABLED (commented out)

**v1.7.0+ has:**
- Common: G
- Gateway: G
- Designer: D (ENABLED)

**Finding:** Adding Designer scope (v1.6.1 â†’ v1.7.0) likely prevented upgrade due to structural change. This is EXPECTED Ignition behavior for scope changes.

**HOWEVER:** v1.7.0 â†’ v1.7.1 â†’ v1.7.2 â†’ v1.7.3 all have same scopes (G, D), so this doesn't explain those failures!

### 4. Module Signing

**Current Configuration:**
- Self-signed certificate via `sign.props`
- Each build generates new signatures in `signatures.properties`
- Module signed with: `skipModlSigning.set(false)`

**Signatures Change Every Build:**
```properties
/common.jar=FStD9XUkdn5z8f7pvCfTbB1etdHuwIJmO6zN0PfGExaN8xNQXBgnGjfHQOllVF2rm0+KEBbyShxansE13SF6fhj9QrzCKefzDB5pDLTHeKLaNg5tQpgt981y9YztEK3ldvpIzCqPVcRSOQPWpXoxM++D3RbAt7i5hiKNQ0f7xo0bmIxctWNe93mirVp0U7cu2oH6vsXqpoEGmEzleC7mWuBbdMjSepkx1rjyeFZn4WIRjZaIOIkCmLzJ2wUGYQ9gDv8Gf/F358lt4SvpPzR2Kfa/fzOCxGDTm/fE15uilSlNydp8l/T9yYV5FPwgO4C6wUWO0851MwKs5MflWVwOSQ==
```

**Question:** Could changing signatures prevent upgrades? ðŸ¤”

### 5. Comparison with Working Module

Checked `ignition-module-claude` reference:
- Uses VERSIONED jar names: `common-1.0.0.jar`, `designer-1.0.0.jar`, `gateway-1.0.0.jar`
- Same signing approach
- **NOTE:** Only at v1.0.0, so we don't know if it has been successfully upgraded

## What We DON'T Know

### Critical Missing Information:

1. **What EXACTLY happens when upgrade is attempted?**
   - Does Ignition show an error message?
   - Does it accept the file but not upgrade?
   - Does it show new version but actually still old?
   - Is there a specific error in Gateway logs?

2. **Gateway Logs**
   - What does `wrapper.log` say during attempted upgrade?
   - Are there module loading errors?
   - Signature verification failures?

3. **Module State in Gateway**
   - How does Ignition display the module after attempted upgrade?
   - Does it show as "pending restart"?
   - Is there a module state file we can inspect?

4. **Unsigned Module Test**
   - Would it work if we disable signing (`skipModlSigning.set(true)`)?
   - Could self-signed cert be the issue?

## Hypotheses to Test

### Hypothesis 1: Self-Signed Certificate Issue
**Theory:** Ignition might reject upgrades when signature changes (even if cert is same)
**Test:** Build v1.7.4 with `skipModlSigning.set(true)` and try upgrade
**Risk:** Low - can re-enable signing if not the issue

### Hypothesis 2: Module Acceptance in 8.3
**Theory:** Ignition 8.3 requires modules to be "accepted" in `data/modules.json`
**Test:** Check if `data/modules.json` has entry for our module
**Evidence:** SDK docs mention this requirement for 8.3

### Hypothesis 3: Build Timestamp/Metadata
**Theory:** Some hidden metadata (build timestamp, etc.) prevents upgrade
**Test:** Compare complete .modl contents between versions
**Evidence:** SDK docs mention timestamp bugs were fixed in 8.3

### Hypothesis 4: User Workflow Issue
**Theory:** User might not be following correct upgrade procedure
**Test:** Document exact steps and verify with user
**Evidence:** Need to ask user for their exact workflow

## Recommended Next Steps

### Immediate Actions:

1. **Ask User for Detailed Info:**
   - Exact steps they're taking to upgrade
   - Any error messages or warnings
   - Screenshot of module page after attempted upgrade
   - Gateway logs during upgrade attempt

2. **Check Gateway Logs:**
   ```bash
   tail -f <ignition-install>/logs/wrapper.log
   # Look for module loading, signature verification, upgrade attempts
   ```

3. **Test Unsigned Module:**
   - Set `skipModlSigning.set(true)` in build.gradle.kts
   - Build v1.7.4
   - Try upgrade from v1.7.3 â†’ v1.7.4
   - If successful, signing is the issue

4. **Check Ignition Module State:**
   - Look at `<ignition-install>/data/modules.json`
   - Check for our module ID entry
   - Verify acceptance status

5. **Compare with Official Modules:**
   - Check how Inductive Automation's own modules handle upgrades
   - See if they use versioned or static jar names
   - Check their signing approach

### Long-term Solutions:

If we identify the root cause:

**If it's signing:** Use Inductive Automation's official signing service or disable signing
**If it's jar names:** Keep static names (already done in v1.7.2+)
**If it's scopes:** Document one-time manual upgrade when scopes change
**If it's workflow:** Document correct upgrade procedure clearly

## Files Modified in v1.7.2 (Jar Naming Fix)

- `common/build.gradle.kts`: Added `archiveBaseName.set("common")` and `archiveVersion.set("")`
- `gateway/build.gradle.kts`: Added `archiveBaseName.set("gateway")` and `archiveVersion.set("")`
- `designer/build.gradle.kts`: Added `archiveBaseName.set("designer")` and `archiveVersion.set("")`

## Current Module Configuration

**Module ID:** `com.inductiveautomation.ignition.examples.python3`
**Version:** `1.7.3`
**Scopes:** Gateway (G), Designer (D)
**Hooks:**
- Gateway: `com.inductiveautomation.ignition.examples.python3.gateway.GatewayHook`
- Designer: `com.inductiveautomation.ignition.examples.python3.designer.DesignerHook`

**Signing:** Enabled with self-signed certificate

## Conclusion

The root cause of upgrade failures is still UNKNOWN. The jar naming fix (v1.7.2) should have enabled upgrades but didn't. Need more information from user about:
1. Exact upgrade workflow
2. Gateway logs
3. Error messages (if any)
4. Module state after upgrade attempt

**Next investigation should focus on module signing and Ignition 8.3 module acceptance mechanism.**
